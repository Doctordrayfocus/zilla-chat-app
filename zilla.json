{
    "name": "chat",
    "bindings": {
        "tcp_server0": {
            "type": "tcp",
            "kind": "server",
            "options": {
                "host": "0.0.0.0",
                "port": 8080
            },
            "exit": "http_server0"
        },
        "http_server0": {
            "type": "http",
            "kind": "server",
            "options": {
                "access-control": {
                    "policy": "cross-origin"
                }
            },
            "routes": [
                {
                    "when": [
                        {
                            "headers": {
                                ":method": "GET",
                                ":path": "/channels/*/messages"
                            }
                        }
                    ],
                    "exit": "sse_server0"
                },
                {
                    "when": [
                        {
                            "headers": {
                                ":method": "POST",
                                ":path": "/channels"
                            }
                        },
                        {
                            "headers": {
                                ":method": "POST",
                                ":path": "/channels/*"
                            }
                        },
                        {
                            "headers": {
                                ":method": "GET",
                                ":path": "/channels"
                            }
                        },
                        {
                            "headers": {
                                ":method": "GET",
                                ":path": "/channels/*"
                            }
                        },
                        {
                            "headers": {
                                ":method": "POST",
                                ":path": "/subscription/subscribe"
                            }
                        },
                        {
                            "headers": {
                                ":method": "POST",
                                ":path": "/users"
                            }
                        },
                        {
                            "headers": {
                                ":method": "GET",
                                ":path": "/users"
                            }
                        },
                        {
                            "headers": {
                                ":method": "PUT",
                                ":path": "/users/*"
                            }
                        },
                        {
                            "headers": {
                                ":method": "GET",
                                ":path": "/users/*"
                            }
                        }

                    ],
                    "exit": "http_kafka_proxy0"
                }
            ]
        },
        "http_kafka_proxy0": {
            "type": "http-kafka",
            "kind": "proxy",
            "routes": [
                {
                    "when": [
                        {
                            "method": "POST",
                            "path": "/channels/{id}/messages"
                        }
                    ],
                    "exit": "kafka_cache_client0",
                    "with":
                    {
                        "capability": "produce",
                        "topic": "messages",
                        "key": "${idempotencyKey}",
                        "overrides":
                        {
                            "channel-id": "${params.id}"
                        }
                    }
                },
                {
                    "when": [
                        {
                            "method": "POST",
                            "path": "/channels"
                        }
                    ],
                    "exit": "kafka_cache_client0",
                    "with":
                    {
                        "capability": "produce",
                        "topic": "channels",
                        "key": "${idempotencyKey}"
                    }
                },
                {
                    "when": [
                        {
                            "method": "GET",
                            "path": "/channels"
                        }
                    ],
                    "exit": "kafka_cache_client0",
                    "with":
                    {
                        "capability": "fetch",
                        "topic": "channels",
                        "merge":
                        {
                            "content-type": "application/json"
                        }
                    }
                },
                {
                    "when": [
                        {
                            "method": "GET",
                            "path": "/channels/{id}/members"
                        }
                    ],
                    "exit": "kafka_cache_client0",
                    "with":
                    {
                        "capability": "fetch",
                        "topic": "subscriptions",
                        "merge":
                        {
                            "content-type": "application/json"
                        },
                        "filters":
                        [
                            {
                                "headers":
                                {
                                    "channel-id": "${params.id}"
                                }
                            }
                        ]
                    }
                },
                {
                    "when": [
                        {
                            "method": "GET",
                            "path": "/channels/{id}"
                        }
                    ],
                    "exit": "kafka_cache_client0",
                    "with":
                    {
                        "capability": "fetch",
                        "topic": "channels",
                        "merge":
                        {
                            "content-type": "application/json"
                        },
                        "filters":
                        [
                            {
                                "key": "${params.id}"
                            }
                        ]
                    }
                },
                {
                    "when": [
                        {
                            "method": "POST",
                            "path": "/subscription/subscribe"
                        }
                    ],
                    "exit": "kafka_cache_client0",
                    "with":
                    {
                        "capability": "produce",
                        "topic": "commands",
                        "key": "${idempotencyKey}",
                        "overrides": {
                            "domain-model": "SubscribeCommand"
                        }
                    }
                },
                {
                    "when": [
                        {
                            "method": "POST",
                            "path": "/users"
                        }
                    ],
                    "exit": "kafka_cache_client0",
                    "with":
                    {
                        "capability": "produce",
                        "topic": "users",
                        "key": "${idempotencyKey}"
                    }
                },
                {
                    "when": [
                        {
                            "method": "PUT",
                            "path": "/users/{id}"
                        }
                    ],
                    "exit": "kafka_cache_client0",
                    "with":
                    {
                        "capability": "produce",
                        "topic": "users",
                        "key": "${params.id}"
                    }
                },
                {
                    "when": [
                        {
                            "method": "GET",
                            "path": "/users"
                        }
                    ],
                    "exit": "kafka_cache_client0",
                    "with":
                    {
                        "capability": "fetch",
                        "topic": "users",
                        "merge":
                        {
                            "content-type": "application/json"
                        }
                    }
                },
                {
                    "when": [
                        {
                            "method": "GET",
                            "path": "/users/{id}"
                        }
                    ],
                    "exit": "kafka_cache_client0",
                    "with":
                    {
                        "capability": "fetch",
                        "topic": "users",
                        "merge":
                        {
                            "content-type": "application/json"
                        },
                        "filters":
                        [
                            {
                                "key": "${params.id}"
                            }
                        ]
                    }
                }
            ]
        },
        "sse_server0":
        {
            "type" : "sse",
            "kind": "server",
            "exit": "sse_kafka_proxy0"
        },
        "sse_kafka_proxy0":
        {
            "type" : "sse-kafka",
            "kind": "proxy",
            "routes":
            [
                {
                    "when":
                    [
                        {
                            "path": "/channels/{id}/messages"
                        }
                    ],
                    "exit": "kafka_cache_client0",
                    "with":
                    {
                        "topic": "messages",
                        "filters":
                        [
                            {
                                "headers":
                                {
                                    "channel-id": "${params.id}"
                                }
                            }
                        ]
                    }
                }
            ]
        },
        "kafka_cache_client0": {
            "type": "kafka",
            "kind": "cache_client",
            "exit": "kafka_cache_server0"
        },
        "kafka_cache_server0": {
            "type": "kafka",
            "kind": "cache_server",
            "options": {
                "bootstrap": [
                    "channels"
                ]
            },
            "exit": "kafka_client0"
        },
        "kafka_client0": {
            "type": "kafka",
            "kind": "client",
            "exit": "tcp_client0"
        },
        "tcp_client0": {
            "type": "tcp",
            "kind": "client",
            "options": {
                "host": "kafka.internal.net",
                "port": 29092
            },
            "routes": [
                {
                    "when": [
                        {
                            "cidr": "0.0.0.0/0"
                        }
                    ]
                }
            ]
        }
    }
}
